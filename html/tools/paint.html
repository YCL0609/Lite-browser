<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="note.js"></script>
    <title>画图板</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
            background: white;
            cursor: crosshair;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #333;
                color: white;
            }

            canvas {
                background: #333;
                /* border: 1px solid #555; */
            }
        }
    </style>
</head>

<body>
    <canvas id="drawingCanvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const noteID = showMessage(null, '左键绘制, 右键擦除, Ctrl+S保存图片');
            setTimeout(() => closeMessage(noteID), 2000);
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                const canvas = document.getElementById('drawingCanvas');
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'canvas-image.png';
                link.href = image;
                link.click();
            }
        });

        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');

        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let isErasing = false;

        function resizeCanvas() {
            const oldData = canvas.toDataURL();
            const img = new Image();
            img.src = oldData;

            img.onload = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.drawImage(img, 0, 0);
            };
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        canvas.addEventListener('mousedown', (e) => {
            e.preventDefault();
            isDrawing = true;
            isErasing = (e.button === 2);
            [lastX, lastY] = [e.offsetX, e.offsetY];
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (isErasing) {
                ctx.strokeStyle = isDark ? getComputedStyle(canvas).backgroundColor : 'white';
                ctx.lineWidth = 20;
            } else {
                ctx.strokeStyle = isDark ? 'white' : 'black';
                ctx.lineWidth = 2;
            }

            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        });

        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseleave', () => isDrawing = false);
    </script>
</body>

</html>